#!/bin/bash

# TODO add --assume_yes
# TODO add --quiet

# cr [--dry-run] [-i <issue number>] []

JIRA_USER=ryan.chipman
CR_PATH="$HOME/bin/mongodb/upload.py"
REVIEWERS="jeff.yemin@10gen.com,craig.wilson@10gen.com,wisdom.omuya@10gen.com"
CC_LIST=""

while getopts "di:m:r:" opt; do
    case $opt in
        d)
            DRY_RUN=true
            ;;
        i)
            ISSUE="$OPTARG"
            ISSUE_FLAG="--issue=$ISSUE"
            JIRA_FLAG="--nojira"
            ;;
        m)
            MESSAGE="$OPTARG"
            ;;
        r)
            MERGE_BASE="$OPTARG"
            ;;
    esac
done

# get current branch
function get_git_branch() {
    git branch --no-color 2> /dev/null | sed -e "/^[^*]/d" -e "s/* \(.*\)/\1/"
}

if [ -z "${JIRA_TICKET}" ]; then
    JIRA_TICKET=`get_git_branch | sed -e "s/^.*-\([A-Z]*-[0-9]*\).*/\1/"`
fi

if [ -z "${JIRA_FLAG}" ]; then
    JIRA_FLAG="--jira=${JIRA_TICKET}"
fi

# get merge base
if [ -z "${MERGE_BASE}" ]; then
    MERGE_BASE=$(git merge-base master HEAD)
fi

DESCRIPTION="https://jira.mongodb.org/browse/${JIRA_TICKET}

$MESSAGE"

if [ -z "${ISSUE_FLAG}" ]; then
    DESCRIPTION_FLAG="--description=$DESCRIPTION"
else
    ""
    # TODO get description from git commit titles
fi
# TODO make description a separate variable

echo "Dry Run: ${DRY_RUN:-false}"
echo "Merge Base: ${MERGE_BASE}"
echo "Issue Flag: ${ISSUE_FLAG}"
echo "Jira Flag: ${JIRA_FLAG}"
echo "Description Flag: ${DESCRIPTION_FLAG}"

if [ -n "$DRY_RUN" ]; then
    exit 0
fi

python2 ${CR_PATH} --title="${JIRA_TICKET}${DESC}" --rev=${MERGE_BASE} \
    ${DESCRIPTION_FLAG} \
    --jira_user $JIRA_USER \
    --cc="${CC_LIST}" \
    --reviewers="${REVIEWERS}" \
    ${LINT_FLAGS} ${ISSUE_FLAG} ${JIRA_FLAG} \
    --oauth2
    #--check-clang-format \
    #--check-eslint \
